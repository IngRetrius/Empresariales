<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Completa - Sistema Agropecuario</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .vista-completa-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .panel-maestro {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .panel-detalle {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .producto-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .producto-item:hover {
            background: #f5f5f5;
            border-color: #4CAF50;
            transform: translateX(5px);
        }

        .producto-item.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .producto-item.active h4,
        .producto-item.active p {
            color: white;
        }

        .producto-item h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #333;
        }

        .producto-item p {
            margin: 3px 0;
            font-size: 13px;
            color: #666;
        }

        .seccion-datos {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .seccion-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .seccion-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .seccion-body {
            padding: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-item .value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .stat-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .tabla-simple {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .tabla-simple th,
        .tabla-simple td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .tabla-simple th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
            font-size: 13px;
            text-transform: uppercase;
        }

        .tabla-simple tbody tr:hover {
            background: #f9f9f9;
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

        @media (max-width: 768px) {
            .vista-completa-container {
                grid-template-columns: 1fr;
            }

            .panel-maestro {
                position: relative;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header Component -->
    <div data-component="header"></div>

    <!-- Navigation Component -->
    <div data-component="nav"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <section class="section active">
                <div class="section-header">
                    <h2>Vista Completa: Producto ‚Üí Cosechas ‚Üí Insumos</h2>
                    <p class="section-description">Visualizaci√≥n completa de la relaci√≥n entre productos, cosechas e insumos</p>
                </div>

                <div class="vista-completa-container">
                    <!-- PANEL IZQUIERDO: LISTA DE PRODUCTOS -->
                    <div class="panel-maestro">
                        <div class="card">
                            <div class="card-header">
                                <h3>Productos</h3>
                            </div>
                            <div class="card-body">
                                <div id="lista-productos" style="max-height: 70vh; overflow-y: auto;">
                                    <p class="text-center">Cargando productos...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PANEL DERECHO: DETALLE COMPLETO -->
                    <div class="panel-detalle">
                        <!-- Estado Vac√≠o -->
                        <div id="detalle-vacio" class="card">
                            <div class="card-body empty-state">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="9" y1="9" x2="15" y2="9"></line>
                                    <line x1="9" y1="15" x2="15" y2="15"></line>
                                </svg>
                                <h3>Selecciona un producto</h3>
                                <p>Haz clic en un producto de la lista para ver toda su informaci√≥n, cosechas e insumos asociados</p>
                            </div>
                        </div>

                        <!-- Contenedor de Detalles -->
                        <div id="detalle-contenedor" class="hidden">
                            <!-- 1. INFORMACI√ìN DEL PRODUCTO -->
                            <div class="seccion-datos">
                                <div class="seccion-header">
                                    <h3>üì¶ Informaci√≥n del Producto</h3>
                                </div>
                                <div class="seccion-body">
                                    <div id="info-producto" class="info-grid">
                                        <!-- Se llena din√°micamente -->
                                    </div>
                                </div>
                            </div>

                            <!-- 2. COSECHAS DEL PRODUCTO -->
                            <div class="seccion-datos">
                                <div class="seccion-header">
                                    <h3>üåæ Cosechas del Producto</h3>
                                    <span id="badge-total-cosechas" class="badge badge-light">0 cosechas</span>
                                </div>
                                <div class="seccion-body">
                                    <div id="estadisticas-cosechas" class="stats-row">
                                        <!-- Se llena din√°micamente -->
                                    </div>
                                    <div id="tabla-cosechas-container">
                                        <table class="tabla-simple">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Fecha</th>
                                                    <th>Cantidad (kg)</th>
                                                    <th>Calidad</th>
                                                    <th>Estado</th>
                                                    <th>Trabajadores</th>
                                                    <th>Costo M.O.</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbody-cosechas">
                                                <tr>
                                                    <td colspan="7" class="text-center">No hay cosechas registradas</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. INSUMOS DEL PRODUCTO -->
                            <div class="seccion-datos">
                                <div class="seccion-header">
                                    <h3>üß™ Insumos del Producto</h3>
                                    <span id="badge-total-insumos" class="badge badge-light">0 insumos</span>
                                </div>
                                <div class="seccion-body">
                                    <div id="estadisticas-insumos" class="stats-row">
                                        <!-- Se llena din√°micamente -->
                                    </div>
                                    <div id="tabla-insumos-container">
                                        <table class="tabla-simple">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Nombre</th>
                                                    <th>Tipo</th>
                                                    <th>Cantidad</th>
                                                    <th>Costo Unit.</th>
                                                    <th>Costo Total</th>
                                                    <th>Proveedor</th>
                                                    <th>Fecha Compra</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbody-insumos">
                                                <tr>
                                                    <td colspan="8" class="text-center">No hay insumos registrados</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. RESUMEN FINANCIERO -->
                            <div class="seccion-datos">
                                <div class="seccion-header">
                                    <h3>üí∞ Resumen Financiero</h3>
                                </div>
                                <div class="seccion-body">
                                    <div class="stats-row">
                                        <div class="stat-card green">
                                            <h4>Costo Producci√≥n</h4>
                                            <div class="stat-value" id="stat-costo-produccion">$0</div>
                                            <small>Producto</small>
                                        </div>
                                        <div class="stat-card blue">
                                            <h4>Costo Mano de Obra</h4>
                                            <div class="stat-value" id="stat-costo-mano-obra">$0</div>
                                            <small>Cosechas</small>
                                        </div>
                                        <div class="stat-card orange">
                                            <h4>Costo Insumos</h4>
                                            <div class="stat-value" id="stat-costo-insumos">$0</div>
                                            <small>Total insumos</small>
                                        </div>
                                        <div class="stat-card">
                                            <h4>Costo Total</h4>
                                            <div class="stat-value" id="stat-costo-total">$0</div>
                                            <small>Suma de todos los costos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer Component -->
    <div data-component="footer"></div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <script src="../js/components-loader.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/ui.js"></script>
    <script src="../js/utils.js"></script>

    <script>
        // ==================== ESTADO GLOBAL ====================
        let productosData = [];
        let productoSeleccionado = null;

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[VISTA COMPLETA] Inicializando...');
            await cargarProductos();
        });

        // ==================== CARGA DE DATOS ====================

        /**
         * Carga todos los productos
         */
        async function cargarProductos() {
            try {
                console.log('[VISTA COMPLETA] Cargando productos...');
                productosData = await API.obtenerProductos();
                console.log(`[VISTA COMPLETA] ${productosData.length} productos cargados`);

                renderizarListaProductos();

            } catch (error) {
                console.error('[VISTA COMPLETA] Error al cargar productos:', error);
                document.getElementById('lista-productos').innerHTML =
                    '<p class="text-center error">Error al cargar productos</p>';
                UI.mostrarToast('Error al cargar productos', 'error');
            }
        }

        /**
         * Renderiza la lista de productos
         */
        function renderizarListaProductos() {
            const lista = document.getElementById('lista-productos');

            if (productosData.length === 0) {
                lista.innerHTML = '<p class="text-center">No hay productos disponibles</p>';
                return;
            }

            lista.innerHTML = productosData.map(producto => `
                <div class="producto-item" onclick="seleccionarProducto('${producto.id}')">
                    <h4>${producto.nombre}</h4>
                    <p><strong>ID:</strong> ${producto.id}</p>
                    <p><strong>Tipo:</strong> ${producto.tipoCultivo}</p>
                    <p><strong>Hect√°reas:</strong> ${API.formatearNumero(producto.hectareasCultivadas, 2)}</p>
                </div>
            `).join('');
        }

        /**
         * Selecciona un producto y carga todos sus datos
         */
        async function seleccionarProducto(productoId) {
            try {
                console.log(`[VISTA COMPLETA] Seleccionando producto: ${productoId}`);

                // Actualizar UI de selecci√≥n
                document.querySelectorAll('.producto-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.currentTarget.classList.add('active');

                // Cargar datos del producto
                productoSeleccionado = await API.obtenerProductoPorId(productoId);
                console.log('[VISTA COMPLETA] Producto cargado:', productoSeleccionado);

                // Mostrar secci√≥n de detalles
                document.getElementById('detalle-vacio').classList.add('hidden');
                document.getElementById('detalle-contenedor').classList.remove('hidden');

                // Renderizar informaci√≥n del producto
                renderizarInformacionProducto(productoSeleccionado);

                // Cargar y renderizar cosechas
                await cargarCosechas(productoId);

                // Cargar y renderizar insumos
                await cargarInsumos(productoId);

                // Calcular resumen financiero
                calcularResumenFinanciero();

            } catch (error) {
                console.error('[VISTA COMPLETA] Error al seleccionar producto:', error);
                UI.mostrarToast('Error al cargar informaci√≥n del producto', 'error');
            }
        }

        /**
         * Renderiza la informaci√≥n del producto
         */
        function renderizarInformacionProducto(producto) {
            const container = document.getElementById('info-producto');

            container.innerHTML = `
                <div class="info-item">
                    <label>ID</label>
                    <div class="value">${producto.id}</div>
                </div>
                <div class="info-item">
                    <label>Nombre</label>
                    <div class="value">${producto.nombre}</div>
                </div>
                <div class="info-item">
                    <label>Tipo de Cultivo</label>
                    <div class="value">${producto.tipoCultivo}</div>
                </div>
                <div class="info-item">
                    <label>Hect√°reas Cultivadas</label>
                    <div class="value">${API.formatearNumero(producto.hectareasCultivadas, 2)} ha</div>
                </div>
                <div class="info-item">
                    <label>Cantidad Producida</label>
                    <div class="value">${API.formatearNumero(producto.cantidadProducida)} kg</div>
                </div>
                <div class="info-item">
                    <label>Precio de Venta</label>
                    <div class="value">${API.formatearMoneda(producto.precioVenta)}</div>
                </div>
                <div class="info-item">
                    <label>Costo de Producci√≥n</label>
                    <div class="value">${API.formatearMoneda(producto.costoProduccion)}</div>
                </div>
                <div class="info-item">
                    <label>Temporada</label>
                    <div class="value">${producto.temporada}</div>
                </div>
                <div class="info-item">
                    <label>Tipo de Suelo</label>
                    <div class="value">${producto.tipoSuelo}</div>
                </div>
                <div class="info-item">
                    <label>C√≥digo de Finca</label>
                    <div class="value">${producto.codigoFinca}</div>
                </div>
            `;
        }

        /**
         * Carga las cosechas del producto
         */
        async function cargarCosechas(productoId) {
            try {
                console.log(`[VISTA COMPLETA] Cargando cosechas del producto: ${productoId}`);
                const cosechas = await API.obtenerCosechasPorProducto(productoId);
                console.log(`[VISTA COMPLETA] ${cosechas.length} cosechas cargadas`);

                renderizarCosechas(cosechas);

            } catch (error) {
                console.error('[VISTA COMPLETA] Error al cargar cosechas:', error);
                document.getElementById('tbody-cosechas').innerHTML =
                    '<tr><td colspan="7" class="text-center error">Error al cargar cosechas</td></tr>';
            }
        }

        /**
         * Renderiza las cosechas
         */
        function renderizarCosechas(cosechas) {
            const tbody = document.getElementById('tbody-cosechas');
            const badge = document.getElementById('badge-total-cosechas');
            const statsContainer = document.getElementById('estadisticas-cosechas');

            badge.textContent = `${cosechas.length} cosechas`;

            if (cosechas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay cosechas registradas</td></tr>';
                statsContainer.innerHTML = '';
                return;
            }

            // Calcular estad√≠sticas
            const totalCantidad = cosechas.reduce((sum, c) => sum + (c.cantidadRecolectada || 0), 0);
            const totalCostoMO = cosechas.reduce((sum, c) => sum + (c.costoManoObra || 0), 0);
            const totalTrabajadores = cosechas.reduce((sum, c) => sum + (c.numeroTrabajadores || 0), 0);

            statsContainer.innerHTML = `
                <div class="stat-card green">
                    <h4>Total Recolectado</h4>
                    <div class="stat-value">${API.formatearNumero(totalCantidad)}</div>
                    <small>kilogramos</small>
                </div>
                <div class="stat-card blue">
                    <h4>Costo Mano de Obra</h4>
                    <div class="stat-value">${API.formatearMoneda(totalCostoMO)}</div>
                    <small>total</small>
                </div>
                <div class="stat-card orange">
                    <h4>Trabajadores</h4>
                    <div class="stat-value">${totalTrabajadores}</div>
                    <small>total</small>
                </div>
            `;

            tbody.innerHTML = cosechas.map(cosecha => `
                <tr>
                    <td>${cosecha.id}</td>
                    <td>${formatearFechaCorta(cosecha.fechaCosecha)}</td>
                    <td>${API.formatearNumero(cosecha.cantidadRecolectada)}</td>
                    <td><span class="badge badge-success">${cosecha.calidad}</span></td>
                    <td><span class="badge badge-info">${cosecha.estado || 'N/A'}</span></td>
                    <td>${cosecha.numeroTrabajadores || 0}</td>
                    <td>${API.formatearMoneda(cosecha.costoManoObra || 0)}</td>
                </tr>
            `).join('');
        }

        /**
         * Carga los insumos del producto
         */
        async function cargarInsumos(productoId) {
            try {
                console.log(`[VISTA COMPLETA] Cargando insumos del producto: ${productoId}`);
                const insumos = await API.obtenerInsumosPorProducto(productoId);
                console.log(`[VISTA COMPLETA] ${insumos.length} insumos cargados`);

                renderizarInsumos(insumos);

            } catch (error) {
                console.error('[VISTA COMPLETA] Error al cargar insumos:', error);
                document.getElementById('tbody-insumos').innerHTML =
                    '<tr><td colspan="8" class="text-center error">Error al cargar insumos</td></tr>';
            }
        }

        /**
         * Renderiza los insumos
         */
        function renderizarInsumos(insumos) {
            const tbody = document.getElementById('tbody-insumos');
            const badge = document.getElementById('badge-total-insumos');
            const statsContainer = document.getElementById('estadisticas-insumos');

            badge.textContent = `${insumos.length} insumos`;

            if (insumos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay insumos registrados</td></tr>';
                statsContainer.innerHTML = '';
                return;
            }

            // Calcular estad√≠sticas
            const totalCosto = insumos.reduce((sum, i) => sum + (i.costoTotal || 0), 0);
            const totalCantidad = insumos.reduce((sum, i) => sum + (i.cantidad || 0), 0);

            statsContainer.innerHTML = `
                <div class="stat-card orange">
                    <h4>Costo Total Insumos</h4>
                    <div class="stat-value">${API.formatearMoneda(totalCosto)}</div>
                    <small>inversi√≥n total</small>
                </div>
                <div class="stat-card blue">
                    <h4>Total Items</h4>
                    <div class="stat-value">${totalCantidad}</div>
                    <small>unidades/kg/litros</small>
                </div>
            `;

            tbody.innerHTML = insumos.map(insumo => `
                <tr>
                    <td>${insumo.id}</td>
                    <td>${insumo.nombre}</td>
                    <td><span class="badge badge-info">${formatearTipoInsumo(insumo.tipo)}</span></td>
                    <td>${API.formatearNumero(insumo.cantidad)} ${insumo.unidadMedida || ''}</td>
                    <td>${API.formatearMoneda(insumo.costoUnitario)}</td>
                    <td><strong>${API.formatearMoneda(insumo.costoTotal)}</strong></td>
                    <td>${insumo.proveedor}</td>
                    <td>${formatearFechaCorta(insumo.fechaCompra)}</td>
                </tr>
            `).join('');
        }

        /**
         * Calcula el resumen financiero
         */
        async function calcularResumenFinanciero() {
            try {
                const productoId = productoSeleccionado.id;

                // Obtener cosechas e insumos
                const cosechas = await API.obtenerCosechasPorProducto(productoId);
                const insumos = await API.obtenerInsumosPorProducto(productoId);

                // Calcular totales
                const costoProduccion = productoSeleccionado.costoProduccion || 0;
                const costoManoObra = cosechas.reduce((sum, c) => sum + (c.costoManoObra || 0), 0);
                const costoInsumos = insumos.reduce((sum, i) => sum + (i.costoTotal || 0), 0);
                const costoTotal = costoProduccion + costoManoObra + costoInsumos;

                // Actualizar UI
                document.getElementById('stat-costo-produccion').textContent = API.formatearMoneda(costoProduccion);
                document.getElementById('stat-costo-mano-obra').textContent = API.formatearMoneda(costoManoObra);
                document.getElementById('stat-costo-insumos').textContent = API.formatearMoneda(costoInsumos);
                document.getElementById('stat-costo-total').textContent = API.formatearMoneda(costoTotal);

            } catch (error) {
                console.error('[VISTA COMPLETA] Error al calcular resumen financiero:', error);
            }
        }

        // ==================== UTILIDADES ====================

        function formatearFechaCorta(fecha) {
            if (!fecha) return 'N/A';
            try {
                const date = new Date(fecha);
                const dia = date.getDate().toString().padStart(2, '0');
                const mes = (date.getMonth() + 1).toString().padStart(2, '0');
                const anio = date.getFullYear();
                return `${dia}/${mes}/${anio}`;
            } catch (error) {
                return 'N/A';
            }
        }

        function formatearTipoInsumo(tipo) {
            if (!tipo) return 'N/A';
            return tipo.replace(/_/g, ' ').toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        console.log('[VISTA COMPLETA] M√≥dulo cargado');
    </script>
</body>
</html>
