<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Completa - Sistema Agropecuario</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .vista-completa-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        .panel-maestro {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .panel-detalle {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .producto-item {
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .producto-item:hover {
            background: #f8f9fa;
            border-color: #2e7d32;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .producto-item.active {
            background: #2e7d32;
            color: white;
            border-color: #1b5e20;
        }

        .producto-item.active h4,
        .producto-item.active p {
            color: white;
        }

        .producto-item h4 {
            margin: 0 0 8px 0;
            font-size: 15px;
            font-weight: 600;
            color: #212121;
        }

        .producto-item p {
            margin: 4px 0;
            font-size: 13px;
            color: #616161;
        }

        .producto-item strong {
            font-weight: 600;
        }

        .seccion-datos {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .seccion-header {
            background: #fafafa;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 8px 8px 0 0;
        }

        .seccion-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #212121;
        }

        .seccion-body {
            padding: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .info-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            border-left: 3px solid #2e7d32;
        }

        .info-item label {
            display: block;
            font-size: 11px;
            color: #616161;
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item .value {
            font-size: 15px;
            color: #212121;
            font-weight: 500;
        }

        .tabla-simple {
            width: 100%;
            border-collapse: collapse;
        }

        .tabla-simple th {
            padding: 12px;
            text-align: left;
            background: #fafafa;
            font-weight: 600;
            color: #212121;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tabla-simple td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #424242;
            font-size: 14px;
        }

        .tabla-simple tbody tr:hover {
            background: #fafafa;
        }

        .badge-count {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .empty-state {
            padding: 80px 20px;
            text-align: center;
            color: #9e9e9e;
        }

        .empty-state h3 {
            color: #616161;
            margin: 16px 0 8px 0;
            font-weight: 500;
        }

        .empty-state p {
            color: #9e9e9e;
            font-size: 14px;
        }

        .no-data {
            text-align: center;
            padding: 32px;
            color: #9e9e9e;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background: #c62828;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .vista-completa-container {
                grid-template-columns: 1fr;
            }

            .panel-maestro {
                position: relative;
                max-height: none;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header Component -->
    <div data-component="header"></div>

    <!-- Navigation Component -->
    <div data-component="nav"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <section class="section active">
                <div class="section-header">
                    <h2>Vista Completa del Producto</h2>
                    <p class="section-description">Información detallada del producto, sus cosechas e insumos asociados</p>
                </div>

                <div class="vista-completa-container">
                    <!-- PANEL IZQUIERDO: LISTA DE PRODUCTOS -->
                    <div class="panel-maestro">
                        <div class="card">
                            <div class="card-header">
                                <h3>Productos</h3>
                            </div>
                            <div class="card-body">
                                <div id="lista-productos">
                                    <p class="text-center">Cargando productos...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PANEL DERECHO: DETALLE COMPLETO -->
                    <div class="panel-detalle">
                        <!-- Estado Vacío -->
                        <div id="detalle-vacio" class="card">
                            <div class="card-body empty-state">
                                <h3>Seleccione un producto</h3>
                                <p>Haga clic en un producto de la lista para ver su información completa</p>
                            </div>
                        </div>

                        <!-- Contenedor de Detalles -->
                        <div id="detalle-contenedor" class="hidden">
                            <!-- 1. INFORMACIÓN DEL PRODUCTO -->
                            <div class="seccion-datos">
                                <div class="seccion-header">
                                    <h3>Información del Producto</h3>
                                </div>
                                <div class="seccion-body">
                                    <div id="info-producto" class="info-grid"></div>
                                </div>
                            </div>

                            <!-- 2. COSECHAS DEL PRODUCTO -->
                            <div class="seccion-datos">
                                <div class="seccion-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3>Cosechas del Producto</h3>
                                    <span id="badge-total-cosechas" class="badge-count">0 registros</span>
                                </div>
                                <div class="seccion-body">
                                    <div id="tabla-cosechas-container">
                                        <table class="tabla-simple">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Fecha</th>
                                                    <th>Cantidad (kg)</th>
                                                    <th>Calidad</th>
                                                    <th>Trabajadores</th>
                                                    <th style="min-width: 160px;">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbody-cosechas">
                                                <tr>
                                                    <td colspan="6" class="no-data">No hay cosechas registradas</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. INSUMOS DEL PRODUCTO -->
                            <div class="seccion-datos">
                                <div class="seccion-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3>Insumos del Producto</h3>
                                    <span id="badge-total-insumos" class="badge-count">0 registros</span>
                                </div>
                                <div class="seccion-body">
                                    <div id="tabla-insumos-container">
                                        <table class="tabla-simple">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Nombre</th>
                                                    <th>Tipo</th>
                                                    <th>Cantidad</th>
                                                    <th>Costo Unit.</th>
                                                    <th>Costo Total</th>
                                                    <th>Proveedor</th>
                                                    <th>Fecha Compra</th>
                                                    <th style="min-width: 160px;">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbody-insumos">
                                                <tr>
                                                    <td colspan="9" class="no-data">No hay insumos registrados</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer Component -->
    <div data-component="footer"></div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <script src="../js/components-loader.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/ui.js"></script>
    <script src="../js/utils.js"></script>

    <script>
        let productosData = [];
        let productoSeleccionado = null;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[VISTA COMPLETA] Inicializando...');
            await cargarProductos();
        });

        async function cargarProductos() {
            try {
                console.log('[VISTA COMPLETA] Cargando productos...');
                productosData = await API.obtenerProductos();
                renderizarListaProductos();
            } catch (error) {
                console.error('[VISTA COMPLETA] Error al cargar productos:', error);
                document.getElementById('lista-productos').innerHTML = '<p class="text-center error">Error al cargar productos</p>';
                UI.mostrarToast('Error al cargar productos', 'error');
            }
        }

        function renderizarListaProductos() {
            const lista = document.getElementById('lista-productos');

            if (productosData.length === 0) {
                lista.innerHTML = '<p class="text-center">No hay productos disponibles</p>';
                return;
            }

            lista.innerHTML = productosData.map(producto => `
                <div class="producto-item" onclick="seleccionarProducto('${producto.id}', event)">
                    <h4>${producto.nombre}</h4>
                    <p><strong>ID:</strong> ${producto.id}</p>
                    <p><strong>Tipo:</strong> ${producto.tipoCultivo}</p>
                    <p><strong>Hectáreas:</strong> ${API.formatearNumero(producto.hectareasCultivadas, 2)}</p>
                </div>
            `).join('');
        }

        async function seleccionarProducto(productoId, event) {
            try {
                console.log(`[VISTA COMPLETA] Seleccionando producto: ${productoId}`);

                document.querySelectorAll('.producto-item').forEach(item => item.classList.remove('active'));
                event.currentTarget.classList.add('active');

                productoSeleccionado = await API.obtenerProductoPorId(productoId);

                document.getElementById('detalle-vacio').classList.add('hidden');
                document.getElementById('detalle-contenedor').classList.remove('hidden');

                renderizarInformacionProducto(productoSeleccionado);
                await cargarCosechas(productoId);
                await cargarInsumos(productoId);

            } catch (error) {
                console.error('[VISTA COMPLETA] Error al seleccionar producto:', error);
                UI.mostrarToast('Error al cargar información del producto', 'error');
            }
        }

        function renderizarInformacionProducto(producto) {
            document.getElementById('info-producto').innerHTML = `
                <div class="info-item">
                    <label>ID del Producto</label>
                    <div class="value">${producto.id}</div>
                </div>
                <div class="info-item">
                    <label>Nombre</label>
                    <div class="value">${producto.nombre}</div>
                </div>
                <div class="info-item">
                    <label>Tipo de Cultivo</label>
                    <div class="value">${producto.tipoCultivo}</div>
                </div>
                <div class="info-item">
                    <label>Hectáreas Cultivadas</label>
                    <div class="value">${API.formatearNumero(producto.hectareasCultivadas, 2)} ha</div>
                </div>
                <div class="info-item">
                    <label>Cantidad Producida</label>
                    <div class="value">${API.formatearNumero(producto.cantidadProducida)} kg</div>
                </div>
                <div class="info-item">
                    <label>Precio de Venta</label>
                    <div class="value">${API.formatearMoneda(producto.precioVenta)}</div>
                </div>
                <div class="info-item">
                    <label>Costo de Producción</label>
                    <div class="value">${API.formatearMoneda(producto.costoProduccion)}</div>
                </div>
                <div class="info-item">
                    <label>Temporada</label>
                    <div class="value">${producto.temporada}</div>
                </div>
                <div class="info-item">
                    <label>Tipo de Suelo</label>
                    <div class="value">${producto.tipoSuelo}</div>
                </div>
                <div class="info-item">
                    <label>Código de Finca</label>
                    <div class="value">${producto.codigoFinca}</div>
                </div>
            `;
        }

        async function cargarCosechas(productoId) {
            try {
                const cosechas = await API.obtenerCosechasPorProducto(productoId);
                renderizarCosechas(cosechas);
            } catch (error) {
                console.error('[VISTA COMPLETA] Error al cargar cosechas:', error);
                document.getElementById('tbody-cosechas').innerHTML = '<tr><td colspan="6" class="no-data">Error al cargar cosechas</td></tr>';
            }
        }

        function renderizarCosechas(cosechas) {
            const tbody = document.getElementById('tbody-cosechas');
            const badge = document.getElementById('badge-total-cosechas');

            badge.textContent = `${cosechas.length} registros`;

            if (cosechas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No hay cosechas registradas para este producto</td></tr>';
                return;
            }

            tbody.innerHTML = cosechas.map(cosecha => `
                <tr>
                    <td>${cosecha.id}</td>
                    <td>${formatearFecha(cosecha.fechaCosecha)}</td>
                    <td>${API.formatearNumero(cosecha.cantidadRecolectada)}</td>
                    <td><span class="badge badge-success">${cosecha.calidadProducto || 'N/A'}</span></td>
                    <td>${cosecha.numeroTrabajadores || 0}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="window.editarCosechaDesdeVista('${cosecha.id}')">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="window.eliminarCosechaDesdeVista('${cosecha.id}')">Eliminar</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function cargarInsumos(productoId) {
            try {
                const insumos = await API.obtenerInsumosPorProducto(productoId);
                renderizarInsumos(insumos);
            } catch (error) {
                console.error('[VISTA COMPLETA] Error al cargar insumos:', error);
                document.getElementById('tbody-insumos').innerHTML = '<tr><td colspan="9" class="no-data">Error al cargar insumos</td></tr>';
            }
        }

        function renderizarInsumos(insumos) {
            const tbody = document.getElementById('tbody-insumos');
            const badge = document.getElementById('badge-total-insumos');

            badge.textContent = `${insumos.length} registros`;

            if (insumos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No hay insumos registrados para este producto</td></tr>';
                return;
            }

            tbody.innerHTML = insumos.map(insumo => `
                <tr>
                    <td>${insumo.id}</td>
                    <td>${insumo.nombre}</td>
                    <td><span class="badge badge-info">${formatearTipo(insumo.tipo)}</span></td>
                    <td>${API.formatearNumero(insumo.cantidad)} ${insumo.unidadMedida || ''}</td>
                    <td>${API.formatearMoneda(insumo.costoUnitario)}</td>
                    <td>${API.formatearMoneda(insumo.costoTotal)}</td>
                    <td>${insumo.proveedor}</td>
                    <td>${formatearFecha(insumo.fechaCompra)}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="window.editarInsumoDesdeVista('${insumo.id}')">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="window.eliminarInsumoDesdeVista('${insumo.id}')">Eliminar</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            try {
                const date = new Date(fecha);
                return date.toLocaleDateString('es-CO');
            } catch (error) {
                return 'N/A';
            }
        }

        function formatearTipo(tipo) {
            if (!tipo) return 'N/A';
            return tipo.replace(/_/g, ' ').toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // FUNCIONES GLOBALES PARA ACCIONES DE COSECHAS
        window.editarCosechaDesdeVista = async function(cosechaId) {
            console.log(`[VISTA COMPLETA] Editando cosecha: ${cosechaId}`);
            // Redirigir a la página de cosechas con el ID
            window.location.href = `cosechas.html?action=edit&id=${cosechaId}`;
        };

        window.eliminarCosechaDesdeVista = async function(cosechaId) {
            console.log(`[VISTA COMPLETA] Eliminando cosecha: ${cosechaId}`);

            const confirmar = confirm(`¿Está seguro que desea eliminar la cosecha ${cosechaId}?\n\nEsta acción no se puede deshacer.`);
            if (!confirmar) return;

            try {
                await API.eliminarCosecha(cosechaId);
                UI.mostrarToast('Cosecha eliminada exitosamente', 'success');

                // Recargar cosechas del producto actual
                if (productoSeleccionado) {
                    await cargarCosechas(productoSeleccionado.id);
                }
            } catch (error) {
                console.error('[VISTA COMPLETA] Error al eliminar cosecha:', error);
                UI.mostrarToast('Error al eliminar la cosecha', 'error');
            }
        };

        // FUNCIONES GLOBALES PARA ACCIONES DE INSUMOS
        window.editarInsumoDesdeVista = async function(insumoId) {
            console.log(`[VISTA COMPLETA] Editando insumo: ${insumoId}`);
            // Redirigir a la página de insumos con el ID
            window.location.href = `insumos.html?action=edit&id=${insumoId}`;
        };

        window.eliminarInsumoDesdeVista = async function(insumoId) {
            console.log(`[VISTA COMPLETA] Eliminando insumo: ${insumoId}`);

            const confirmar = confirm(`¿Está seguro que desea eliminar el insumo ${insumoId}?\n\nEsta acción no se puede deshacer.`);
            if (!confirmar) return;

            try {
                await API.eliminarInsumo(insumoId);
                UI.mostrarToast('Insumo eliminado exitosamente', 'success');

                // Recargar insumos del producto actual
                if (productoSeleccionado) {
                    await cargarInsumos(productoSeleccionado.id);
                }
            } catch (error) {
                console.error('[VISTA COMPLETA] Error al eliminar insumo:', error);
                UI.mostrarToast('Error al eliminar el insumo', 'error');
            }
        };

        console.log('[VISTA COMPLETA] Módulo cargado');
    </script>
</body>
</html>
